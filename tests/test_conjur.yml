---
  - hosts: localhost
    connection: local
    
    tasks:
    - name: Exchange API key for access token
      uri:
        url: "https://{{ ansible_env.CONJUR_APPLIANCE_URL }}/api/authn/host%2Ftower2/authenticate"
        method: POST
        timeout: 10
        validate_certs: no
        headers:
          Content-Type: "text/plain"
        body: {{ ansible_env.CONJUR_AUTHN_API_KEY }}
        return_content yes
        status_code: 200
      register: token_json
    - set_fact: token="{{ token_json | b64encode }}"
    - debug:
        msg: "{{ token }}"

    - name: Use token to retrieve secret
      uri:
        url: "https://{{ansible_env.CONJUR_APPLIANCE_URL}}/api/variables/ansible%2Fdom_admin%2Fpassword/value?1"
        method: GET
        timeout: 10
        validate_certs: no
        headers:
          Authorization: Token token="{{ token }}"
        return_content: yes
        status_code: 200      
    register: variable_value
  - debug:
      msg: "{{ variable_value }}"
