---
  - hosts: localhost
    connection: local
    
  - env:
      CONJUR_APPLIANCE_URL: https://master.nate.lab
      CONJUR_ACCOUNT: CYBR
      CONJUR_AUTHN_LOGIN: host/tower2
      CONJUR_AUTHN_API_KEY: ${ANSIBLE_CONJUR_AUTHN_API_KEY}
      CONJUR_CUSTOM_AUTHN_API_KEY: ${CUSTOM_CONJUR_AUTHN_API_KEY}

    tasks:
    - name: Exchange API key for unformatted access token
      uri:
        url: "https://{{ansible_env.CONJUR_APPLIANCE_URL}}/api/authn/host%2Ftower2/authenticate"
        method: POST
        timeout: 10
        validate_certs: no
        headers:
          Content-Type: "text/plain"
        body: {{ansible_env.CONJUR_AUTHN_API_KEY}}
        register: output
        return_content: yes
        body_format: json
        status_code: 200
      register: token_json

    - name: Base64 encode to format the token
        response: {{ base64encode.token_json }}
      register: token
    
    - name: Use token to retrieve secret
      uri:
        url: "https://{{ansible_env.CONJUR_APPLIANCE_URL}}/api/variables/id"
        method: GET
        timeout: 10
        validate_certs: no
        headers:
          Authorization: Token token="{{ token }}
        register: output
        return_content: yes
        status_code: 200      
    register: variable_value
  - set_fact: foo="{{ variable_value }}"
  - debug:
msg: "{{foo.Content}}"
